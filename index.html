<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OMOPO会員証</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 0; background: #f6f7f9; }
    .wrap { max-width: 420px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border-radius: 14px; padding: 16px; box-shadow: 0 4px 16px rgba(0,0,0,.06); }
    .title { font-size: 18px; font-weight: 700; margin: 0 0 8px; }
    .muted { color: #667085; font-size: 13px; margin: 0; }
    .row { display: flex; justify-content: space-between; gap: 12px; align-items: center; }
    .pt { font-size: 44px; font-weight: 800; line-height: 1; }
    .pt small { font-size: 16px; font-weight: 700; color: #667085; }
    .btn { width: 100%; border: 0; border-radius: 12px; padding: 14px 12px; font-size: 15px; font-weight: 700; cursor: pointer; }
    .btn-primary { background: #06c755; color: #fff; }
    .btn-ghost { background: #f1f3f5; color: #111; margin-top: 10px; }
    .btn-warn { background: #111; color: #fff; margin-top: 10px; }
    .btn-disabled { background: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
    .hr { height: 1px; background: #eceff3; margin: 14px 0; }
    .badge { display: inline-block; padding: 6px 10px; border-radius: 999px; background: #eefaf2; color: #137a3a; font-size: 12px; font-weight: 700; }
    .kv { display: grid; grid-template-columns: 1fr auto; gap: 8px 10px; margin-top: 10px; }
    .kv div { font-size: 13px; color: #344054; }
    .kv div:nth-child(2n) { color: #111; font-weight: 700; text-align: right; }
    input[type="number"], input[type="text"] { width: 100%; max-width: 100%; padding: 12px; font-size: 16px; border-radius: 12px; border: 1px solid #d0d5dd; }
    .note { font-size: 12px; color: #667085; margin-top: 8px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; white-space: pre-wrap; word-break: break-all; background: #f8fafc; border: 1px solid #e5e7eb; padding: 10px; border-radius: 12px; }
    .hidden { display: none; }

    .rewards { margin-top: 10px; display: grid; gap: 10px; }
    .rewardCard { border: 1px solid #eceff3; border-radius: 14px; padding: 12px; background: #fbfcfd; }
    .rewardTop { display: flex; justify-content: space-between; align-items: baseline; gap: 10px; }
    .rewardTitle { font-weight: 800; font-size: 15px; margin: 0; }
    .rewardMeta { color: #667085; font-size: 12px; margin: 2px 0 0; }
    .pill { font-size: 12px; font-weight: 800; padding: 5px 10px; border-radius: 999px; background: #eefaf2; color: #137a3a; }
    .pill-gray { background: #eef2f7; color: #344054; }
    .smallBtn { margin-top: 10px; padding: 12px; border-radius: 12px; border: 0; width: 100%; font-weight: 800; cursor: pointer; }
    .smallBtnPrimary { background: #06c755; color: #fff; }
    .smallBtnDisabled { background: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- ホーム（会員証） -->
    <div id="home" class="card">
      <p class="muted" id="hello">読み込み中...</p>
           <div class="row" style="margin-top:6px;">
        <div>
          <h1 class="title">OMOPO会員証</h1>
          <span class="badge" id="rankBadge">ランク：—</span>
<p class="muted" id="lifetime"></p>
          <div id="lifetime" class="muted" style="margin-top:6px;"></div>
        </div>
        <div class="pt"><span id="points">0</span><small>pt</small></div>
      </div>

      <div class="hr"></div>

      <div class="kv">
        <div>次の景品まで</div><div id="toNext">—</div>
        <div>交換可能</div><div id="redeemable">—</div>
      </div>

      <div class="hr"></div>

      <!-- onclick方式 -->
      <button class="btn btn-primary" id="goAmount" onclick="goAmountClick()">金額入力してポイント申請</button>
      <button class="btn btn-ghost" id="refresh" onclick="refreshClick()">残高を更新</button>

      <div class="hr"></div>

      <h2 class="title" style="margin-bottom:6px;">景品交換</h2>
      <p class="muted">50ptごとに景品と交換できます（到達分だけ表示されます）</p>
      <div id="rewards" class="rewards"></div>

      <p class="note">※ ランクは「累計獲得ポイント」で決まります。<br>
      レギュラー➡シルバー➡ゴールド➡プラチナ➡ダイヤモンド</p>
    </div>

    <!-- 氏名登録（初回のみ） -->
    <div id="profile" class="card hidden">
      <h1 class="title">お名前の登録（初回のみ）</h1>
      <p class="muted">ポイント付与の前に、お名前を登録してください（漢字推奨）</p>

      <div style="margin-top:12px;">
        <input id="lastName" type="text" placeholder="苗字（例：山田）" />
        <div style="height:10px;"></div>
        <input id="firstName" type="text" placeholder="名前（例：太郎）" />
        <p class="note">※ 次回以降は入力不要です</p>
      </div>

      <button class="btn btn-primary" id="saveProfile" style="margin-top:12px;">登録して進む</button>
      <button class="btn btn-ghost" id="cancelProfile">戻る</button>

      <div class="hr"></div>
      <p class="muted" style="margin:0 0 6px;">ログ</p>
      <div id="profileLog" class="mono">準備中…</div>
    </div>

    <!-- 金額入力（申請→承認QR→付与） -->
    <div id="amount" class="card hidden">
      <h1 class="title">金額入力</h1>
      <p class="muted">会計金額を入力 → 申請 → 承認QR読み取り → 付与</p>

      <div style="margin-top:12px;">
        <input id="yen" type="number" inputmode="numeric" placeholder="例：1280" min="0" />
        <p class="note">500円につき1pt：<b id="calcPt">0pt</b></p>
      </div>

      <button class="btn btn-primary" id="apply" style="margin-top:12px;">申請する</button>
      <button class="btn btn-warn" id="scanApprove">承認QRを読み取る（付与）</button>
      <button class="btn btn-ghost" id="backHome">ホームに戻る</button>

      <div class="hr"></div>
      <p class="muted" style="margin:0 0 6px;">ログ</p>
      <div id="log" class="mono">準備中…</div>
      <p class="note">
       <br/>
        
      </p>
    </div>

  </div>

  <script>
    const LIFF_ID = "2008691735-JGZN72Zi";

    const state = {
      displayName: "—",
      userId: null,

      points: 0,               // 残高（交換で減る）
      lifetimePoints: 0,       // 累計（交換で減らない）★追加

      redeemableCount: 0,
      toNext: 0,
      rank: "レギュラー",

      rewardThresholds: [],
      claimedRewards: [],

      requestId: null,
      amount: 0,
      expectedPt: 0,

      profile: null,
    };

    // ★ランク判定（累計ポイントで決まる）
function calcRank(total) {
  if (total >= 201) return "ダイヤモンド";
  if (total >= 151) return "プラチナ";
  if (total >= 101) return "ゴールド";
  if (total >= 51)  return "シルバー";
  return "レギュラー";
}

    function setLog(text) { document.getElementById("log").textContent = text; }
    function setProfileLog(text) { document.getElementById("profileLog").textContent = text; }

    function show(screenId) {
      document.getElementById("home").classList.add("hidden");
      document.getElementById("profile").classList.add("hidden");
      document.getElementById("amount").classList.add("hidden");
      document.getElementById(screenId).classList.remove("hidden");
    }

function renderHome() {
  document.getElementById("hello").textContent =
    state.userId ? `${state.displayName} さん、お疲れ様です！` : "ログイン中…";

 document.getElementById("points").textContent = String(state.lifetimePoints);
  document.getElementById("rankBadge").textContent = `ランク：${state.rank}`;

  document.getElementById("redeemable").textContent = `${state.redeemableCount}回`;
  document.getElementById("toNext").textContent = `${state.toNext}pt`;

  renderRewards();
}



  const REWARDS = {
  50:  "景品：クオカード５００円分",
  100: "景品：クオカード５００円分＋オリジナルグッズ",
  150: "景品：クオカード５００円分",
  200: "景品：クオカード５００円分＋シークレットギフト",
  250: "景品：？？？",
};

function rewardName(th) {
  return REWARDS[th] || `景品（${th}pt）`;
}


    function renderRewards() {
      const wrap = document.getElementById("rewards");
      wrap.innerHTML = "";

      if (!state.rewardThresholds || state.rewardThresholds.length === 0) {
        const div = document.createElement("div");
        div.className = "rewardCard";
        div.innerHTML = `
          <div class="rewardTop">
            <p class="rewardTitle">まだ交換できる景品がありません</p>
            <span class="pill pill-gray">未到達</span>
          </div>
          <p class="rewardMeta">50pt貯まると景品が表示されます</p>
        `;
        wrap.appendChild(div);
        return;
      }

      const claimedSet = new Set(state.claimedRewards || []);
      state.rewardThresholds.forEach((th) => {
        const claimed = claimedSet.has(th);

        const card = document.createElement("div");
        card.className = "rewardCard";

        const statusPill = claimed
          ? `<span class="pill pill-gray">交換済み</span>`
          : `<span class="pill">交換可能</span>`;

        const btnHtml = claimed
          ? `<button class="smallBtn smallBtnDisabled" disabled>交換済み</button>`
          : `<button class="smallBtn smallBtnPrimary" data-th="${th}">景品と交換する</button>`;

        card.innerHTML = `
          <div class="rewardTop">
            <div>
              <p class="rewardTitle">${rewardName(th)}</p>
              <p class="rewardMeta">${th}pt 到達で交換できます</p>
            </div>
            ${statusPill}
          </div>
          ${btnHtml}
        `;
        wrap.appendChild(card);
      });

      wrap.querySelectorAll("button[data-th]").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const th = Number(btn.getAttribute("data-th"));
          await redeemReward(th);
        });
      });
    }

   async function apiGet(path) {
  // ★キャッシュ完全回避：毎回URLに ts を付ける
  const u = new URL(path, location.origin);
  u.searchParams.set("_ts", String(Date.now()));

  const res = await fetch(u.toString(), {
    method: "GET",
    cache: "no-store",
    headers: { "Cache-Control": "no-cache" },
  });

  const data = await res.json().catch(() => ({}));
  if (!res.ok) throw { status: res.status, data };
  return data;
}

    async function ensureProfile() {
      if (!state.userId) return false;
      const r = await apiGet(`/api/profile/get?userId=${encodeURIComponent(state.userId)}`);
      state.profile = r.profile;

      if (state.profile) {
        state.displayName = `${state.profile.last_name} ${state.profile.first_name}`;
        renderHome();
        return true;
      }
      return false;
    }

async function refreshBalance() {
  if (!state.userId) return;

 const data = await apiGet(`/api/me?userId=${encodeURIComponent(state.userId)}`);

state.points = data.points || 0;
state.lifetimePoints = data.lifetimePoints || 0;  // ★追加
state.rank = data.rank || "レギュラー";            // ★追加（rankもAPIから反映）

state.redeemableCount = data.redeemableCount || 0;
state.toNext = data.toNext || 0;
state.rewardThresholds = data.rewardThresholds || [];
state.claimedRewards = data.claimedRewards || [];

renderHome();

}

    async function redeemReward(threshold) {
      try {
        if (!state.userId) return;

        const ok = window.confirm(`${rewardName(threshold)}（${threshold}pt到達）を交換しますか？`);
        if (!ok) return;

        const r = await apiPost("/api/redeem", { userId: state.userId, threshold });
        
        await refreshBalance();

        alert("交換を受け付けました。スタッフに画面を見せてください。");
      } catch (e) {
        if (e?.status === 409 && e?.data?.error === "ALREADY_REDEEMED") {
          alert("この景品はすでに交換済みです。");
          await refreshBalance();
          return;
        }
        if (e?.data?.error === "NOT_ENOUGH_POINTS") {
          alert("ポイントが足りません。");
          return;
        }
        alert("交換エラー: " + JSON.stringify(e?.data || e));
      }
    }

    // onclick 用
    async function goAmountClick() {
      try {
        const hello = document.getElementById("hello");
        if (hello) hello.textContent = "申請ボタン押下：確認中…";

        if (!state.userId) {
          if (hello) hello.textContent = "ユーザーID未取得です（LIFF初期化待ち。少し待って再度お試しください）";
          return;
        }

        const ok = await ensureProfile();
        if (!ok) {
          setProfileLog("苗字・名前を入力して「登録して進む」を押してください");
          show("profile");
          return;
        }

        setLog("金額を入力して「申請する」を押してください");
        show("amount");
      } catch (e) {
        const msg = "goAmountClick エラー: " + JSON.stringify(e?.data || e);
        const hello = document.getElementById("hello");
        if (hello) hello.textContent = msg;
      }
    }

    async function refreshClick() {
      try {
        await refreshBalance();
      } catch (e) {
        const hello = document.getElementById("hello");
        if (hello) hello.textContent = "残高更新エラー: " + JSON.stringify(e?.data || e);
      }
    }

    function setupUI() {
      document.getElementById("cancelProfile").addEventListener("click", () => show("home"));
      document.getElementById("backHome").addEventListener("click", () => show("home"));

      document.getElementById("saveProfile").addEventListener("click", async () => {
        try {
          if (!state.userId) return;

          const last = (document.getElementById("lastName").value || "").trim();
          const first = (document.getElementById("firstName").value || "").trim();
          if (!last || !first) { setProfileLog("苗字・名前を入力してください"); return; }

          setProfileLog("登録中…");
          await apiPost("/api/profile/save", { user_id: state.userId, last_name: last, first_name: first });

          await ensureProfile();
          setProfileLog("登録完了 ✅ 金額入力へ進みます");
          setLog("金額を入力して「申請する」を押してください");
          show("amount");
        } catch (e) {
          if (e?.status === 409) { await ensureProfile(); show("amount"); return; }
          setProfileLog("登録エラー: " + JSON.stringify(e?.data || e));
        }
      });

      const yen = document.getElementById("yen");
      const calcPt = document.getElementById("calcPt");
      yen.addEventListener("input", () => {
        const v = Number(yen.value || 0);
        const p = Math.floor(v / 500);
        calcPt.textContent = `${p}pt`;
      });

      document.getElementById("apply").addEventListener("click", async () => {
        try {
          if (!state.userId) { setLog("ユーザーID未取得です（LINE内で開いてください）"); return; }

          const amount = Number(document.getElementById("yen").value || 0);
          if (amount <= 0) { setLog("金額を入力してください"); return; }

          setLog("申請中…");
          const r = await apiPost("/api/claim/request", { userId: state.userId, amount });

          state.requestId = r.requestId;
          state.amount = r.amount;
          state.expectedPt = r.pt;

          setLog(
            `申請OK\nrequestId=${state.requestId}\namount=${state.amount}\npt=${state.expectedPt}\n\n次に「承認QRを読み取る（付与）」を押してください`
          );
        } catch (e) {
          setLog("申請エラー: " + JSON.stringify(e?.data || e));
        }
      });

      document.getElementById("scanApprove").addEventListener("click", async () => {
        try {
          if (!state.userId) { setLog("ユーザーID未取得です"); return; }
          if (!state.requestId) { setLog("先に「申請する」を押してください"); return; }

          if (!liff.isInClient()) {
            setLog("LINEアプリ内で開いていません。LINE内で miniapp URL を開いてください。");
            return;
          }

          let approveQr = null;
          if (typeof liff.scanCodeV2 === "function") {
            setLog("カメラ起動中…（QRを読み取ってください）");
            const res = await liff.scanCodeV2();
            approveQr = res?.value ?? "";
          } else if (typeof liff.scanCode === "function") {
            setLog("カメラ起動中…（QRを読み取ってください）");
            const res = await liff.scanCode();
            approveQr = res?.value ?? "";
          } else {
            setLog("この環境ではQR読取が利用できません（scanCodeV2/scanCodeが無効）");
            return;
          }

          setLog(`QR読取OK:\n${approveQr}\n\n付与処理中…`);

          const a = await apiPost("/api/claim/approve", {
            userId: state.userId,
            requestId: state.requestId,
            amount: state.amount,
            approveQr
          });

          state.points = a.balance;
          state.redeemableCount = a.redeemableCount;
          state.toNext = a.toNext;

          renderHome();
          setLog(
            `付与成功 ✅\nstoreId=${a.award.storeId}\npt=${a.award.pt}\n新残高=${a.balance}\n\nホームに戻って確認できます`
          );

          await refreshBalance();
        } catch (e) {
          if (e?.status === 409 && e?.data?.error === "ALREADY_AWARDED_TODAY") {
            setLog(`本日はこの店舗では付与済みです。\nstoreId=${e.data.storeId}\n日付=${e.data.date}`);
            return;
          }
          setLog("付与エラー: " + JSON.stringify(e?.data || e));
        }
      });
    }

    async function main() {
      setupUI();
      renderHome();

      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const p = await liff.getProfile();
        state.displayName = p.displayName || "—";
        state.userId = p.userId;

        await ensureProfile();
        renderHome();

        await refreshBalance();
      } catch (e) {
        document.getElementById("hello").textContent = "LIFF初期化エラー：" + (e?.message || e);
      }
    }

    main();
  </script>
</body>
</html>















