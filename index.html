<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ポイント会員証</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 0; background: #f6f7f9; }
    .wrap { max-width: 420px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border-radius: 14px; padding: 16px; box-shadow: 0 4px 16px rgba(0,0,0,.06); }
    .title { font-size: 18px; font-weight: 700; margin: 0 0 8px; }
    .muted { color: #667085; font-size: 13px; margin: 0; }
    .row { display: flex; justify-content: space-between; gap: 12px; align-items: center; }
    .pt { font-size: 44px; font-weight: 800; line-height: 1; }
    .pt small { font-size: 16px; font-weight: 700; color: #667085; }
    .btn { width: 100%; border: 0; border-radius: 12px; padding: 14px 12px; font-size: 15px; font-weight: 700; cursor: pointer; }
    .btn-primary { background: #06c755; color: #fff; }
    .btn-ghost { background: #f1f3f5; color: #111; margin-top: 10px; }
    .btn-warn { background: #111; color: #fff; margin-top: 10px; }
    .hr { height: 1px; background: #eceff3; margin: 14px 0; }
    .badge { display: inline-block; padding: 6px 10px; border-radius: 999px; background: #eefaf2; color: #137a3a; font-size: 12px; font-weight: 700; }
    .kv { display: grid; grid-template-columns: 1fr auto; gap: 8px 10px; margin-top: 10px; }
    .kv div { font-size: 13px; color: #344054; }
    .kv div:nth-child(2n) { color: #111; font-weight: 700; text-align: right; }
    input[type="number"] { width: 100%; padding: 12px; font-size: 16px; border-radius: 12px; border: 1px solid #d0d5dd; }
    .note { font-size: 12px; color: #667085; margin-top: 8px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; white-space: pre-wrap; word-break: break-all; background: #f8fafc; border: 1px solid #e5e7eb; padding: 10px; border-radius: 12px; }
    .hidden { display: none; }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- ホーム（会員証） -->
    <div id="home" class="card">
      <div class="row">
        <div>
          <p class="muted" id="hello">読み込み中...</p>
          <h1 class="title">ポイント会員証</h1>
          <span class="badge" id="rankBadge">ランク：—</span>
        </div>
        <div class="pt"><span id="points">0</span><small>pt</small></div>
      </div>

      <div class="hr"></div>

      <div class="kv">
        <div>次の景品まで</div><div id="toNext">—</div>
        <div>交換可能</div><div id="redeemable">—</div>
      </div>

      <div class="hr"></div>

      <button class="btn btn-primary" id="goAmount">金額入力して申請</button>
      <button class="btn btn-ghost" id="dummyAdd">（仮）+2ptする</button>

      <p class="note">※ STEP B：金額入力→申請（ダミー）→承認QR読み取り（実機確認）まで。</p>
    </div>

    <!-- 金額入力（申請→承認QR読み取り まで） -->
    <div id="amount" class="card hidden">
      <h1 class="title">金額入力</h1>
      <p class="muted">レジで確認した金額を入力（※まだサーバ未接続）</p>

      <div style="margin-top:12px;">
        <input id="yen" type="number" inputmode="numeric" placeholder="例：1280" min="0" />
        <p class="note">500円につき1pt：<b id="calcPt">0pt</b></p>
      </div>

      <button class="btn btn-primary" id="apply" style="margin-top:12px;">申請する（ダミー）</button>
      <button class="btn btn-warn" id="scanApprove">承認QRを読み取る</button>
      <button class="btn btn-ghost" id="backHome">ホームに戻る</button>

      <div class="hr"></div>
      <p class="muted" style="margin:0 0 6px;">読み取り結果</p>
      <div id="scanResult" class="mono">まだ読み取っていません</div>
      <p class="note">
        ※ カメラが起動しない場合：<br/>
        ・LINEアプリ内で開いているか<br/>
        ・LINE Developers側で「Scan QR」を許可しているか<br/>
        ・LINEアプリが最新版か<br/>
        を確認してください。
      </p>
    </div>
  </div>

  <script>
    // あなたの開発用 LIFF ID（入力済み）
    const LIFF_ID = "2008691733-iSoNx2PY";

    // ダミーデータ（後でサーバから取得に置き換える）
    const state = {
      displayName: "—",
      points: 0,
      rank: "レギュラー",
      lastRequest: null, // { amount, pt, createdAt }
    };

    function calcNextInfo(points) {
      const nextThreshold = Math.ceil((points + 1) / 50) * 50;
      const toNext = nextThreshold - points;
      const redeemableCount = Math.floor(points / 50); // 暫定：50ptごとの回数表示
      return { toNext, redeemableCount };
    }

    function renderHome() {
      document.getElementById("hello").textContent = `こんにちは、${state.displayName} さん`;
      document.getElementById("points").textContent = String(state.points);
      document.getElementById("rankBadge").textContent = `ランク：${state.rank}`;

      const { toNext, redeemableCount } = calcNextInfo(state.points);
      document.getElementById("toNext").textContent = `${toNext}pt`;
      document.getElementById("redeemable").textContent = `${redeemableCount}回`;
    }

    function show(screenId) {
      document.getElementById("home").classList.add("hidden");
      document.getElementById("amount").classList.add("hidden");
      document.getElementById(screenId).classList.remove("hidden");
    }

    function setScanResult(text) {
      document.getElementById("scanResult").textContent = text;
    }

    function setupUI() {
      document.getElementById("goAmount").addEventListener("click", () => show("amount"));
      document.getElementById("backHome").addEventListener("click", () => show("home"));

      document.getElementById("dummyAdd").addEventListener("click", () => {
        state.points += 2; // 仮
        renderHome();
      });

      const yen = document.getElementById("yen");
      const calcPt = document.getElementById("calcPt");
      yen.addEventListener("input", () => {
        const v = Number(yen.value || 0);
        const pt = Math.floor(v / 500);
        calcPt.textContent = `${pt}pt`;
      });

      // 申請（ダミー）
      document.getElementById("apply").addEventListener("click", () => {
        const amount = Number(document.getElementById("yen").value || 0);
        const pt = Math.floor(amount / 500);
        state.lastRequest = { amount, pt, createdAt: new Date().toISOString() };
        setScanResult(
          `申請（ダミー）作成:\namount=${amount}\npt=${pt}\n\n次に「承認QRを読み取る」を押してください`
        );
      });

      // ★ 承認QR読み取り（STEP B本体）
      document.getElementById("scanApprove").addEventListener("click", async () => {
        try {
          if (!window.liff) {
            setScanResult("LIFF SDKが読み込まれていません（scriptタグを確認してください）");
            return;
          }
          if (!liff.isInClient()) {
            setScanResult("LINEアプリ内で開いていません。LINE内で miniapp URL を開いてください。");
            return;
          }

          // iPhoneでも動きやすい：scanCodeV2 を優先
          if (typeof liff.scanCodeV2 === "function") {
            setScanResult("カメラ起動中…（scanCodeV2）\nQRを読み取ってください");
            const res = await liff.scanCodeV2(); // { value: "..." }
            const value = res?.value ?? "";
            setScanResult(
              `読み取り成功:\n${value}\n\n（次のSTEP Cで、このvalueをサーバへ送って承認→付与します）`
            );
            return;
          }

          // 互換：scanCode（主にAndroidで動くことが多い）
          if (typeof liff.scanCode === "function") {
            setScanResult("カメラ起動中…（scanCode）\nQRを読み取ってください");
            const res = await liff.scanCode(); // { value: "..." }
            const value = res?.value ?? "";
            setScanResult(
              `読み取り成功:\n${value}\n\n（次のSTEP Cで、このvalueをサーバへ送って承認→付与します）`
            );
            return;
          }

          // ここに来るのは「許可設定OFF」「古いLINE」「環境制限」など
          setScanResult(
            "この環境ではQR読取が利用できません。\n\n確認ポイント：\n" +
            "1) LINE Developersで Scan QR を許可したか\n" +
            "2) LINEアプリ内で開いているか\n" +
            "3) LINEアプリが最新版か\n"
          );
        } catch (e) {
          setScanResult("読み取りキャンセル/エラー:\n" + (e?.message || e));
        }
      });
    }

    async function main() {
      setupUI();
      renderHome();

      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const p = await liff.getProfile();
        state.displayName = p.displayName || "—";
        renderHome();
      } catch (e) {
        document.getElementById("hello").textContent = "LIFF初期化エラー：" + (e?.message || e);
      }
    }

    main();
  </script>
</body>
</html>
