<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ポイント会員証</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 0; background: #f6f7f9; }
    .wrap { max-width: 420px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border-radius: 14px; padding: 16px; box-shadow: 0 4px 16px rgba(0,0,0,.06); }
    .title { font-size: 18px; font-weight: 700; margin: 0 0 8px; }
    .muted { color: #667085; font-size: 13px; margin: 0; }
    .row { display: flex; justify-content: space-between; gap: 12px; align-items: center; }
    .pt { font-size: 44px; font-weight: 800; line-height: 1; }
    .pt small { font-size: 16px; font-weight: 700; color: #667085; }
    .btn { width: 100%; border: 0; border-radius: 12px; padding: 14px 12px; font-size: 15px; font-weight: 700; cursor: pointer; }
    .btn-primary { background: #06c755; color: #fff; }
    .btn-ghost { background: #f1f3f5; color: #111; margin-top: 10px; }
    .btn-warn { background: #111; color: #fff; margin-top: 10px; }
    .hr { height: 1px; background: #eceff3; margin: 14px 0; }
    .badge { display: inline-block; padding: 6px 10px; border-radius: 999px; background: #eefaf2; color: #137a3a; font-size: 12px; font-weight: 700; }
    .kv { display: grid; grid-template-columns: 1fr auto; gap: 8px 10px; margin-top: 10px; }
    .kv div { font-size: 13px; color: #344054; }
    .kv div:nth-child(2n) { color: #111; font-weight: 700; text-align: right; }
    input[type="number"] { width: 100%; padding: 12px; font-size: 16px; border-radius: 12px; border: 1px solid #d0d5dd; }
    .note { font-size: 12px; color: #667085; margin-top: 8px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; white-space: pre-wrap; word-break: break-all; background: #f8fafc; border: 1px solid #e5e7eb; padding: 10px; border-radius: 12px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- ホーム（会員証） -->
    <div id="home" class="card">
      <p class="muted" id="hello">読み込み中...</p>
      <div class="row">
        <div>
          <h1 class="title">ポイント会員証</h1>
          <span class="badge" id="rankBadge">ランク：—</span>
        </div>
        <div class="pt"><span id="points">0</span><small>pt</small></div>
      </div>

      <div class="hr"></div>

      <div class="kv">
        <div>次の景品まで</div><div id="toNext">—</div>
        <div>交換可能</div><div id="redeemable">—</div>
      </div>

      <div class="hr"></div>

      <button class="btn btn-primary" id="goAmount">金額入力してポイント申請</button>
      <button class="btn btn-ghost" id="refresh">残高を更新</button>

      <p class="note">※ 開発中：Vercelのメモリ保存のため、環境更新でポイントがリセットされることがあります（本番はDB化します）。</p>
    </div>

    <!-- 金額入力（申請→承認QR→付与） -->
    <div id="amount" class="card hidden">
      <h1 class="title">金額入力</h1>
      <p class="muted">会計金額を入力 → 申請 → 承認QR読み取り → 付与</p>

      <div style="margin-top:12px;">
        <input id="yen" type="number" inputmode="numeric" placeholder="例：1280" min="0" />
        <p class="note">500円につき1pt：<b id="calcPt">0pt</b></p>
      </div>

      <button class="btn btn-primary" id="apply" style="margin-top:12px;">申請する</button>
      <button class="btn btn-warn" id="scanApprove">承認QRを読み取る（付与）</button>
      <button class="btn btn-ghost" id="backHome">ホームに戻る</button>

      <div class="hr"></div>
      <p class="muted" style="margin:0 0 6px;">ログ</p>
      <div id="log" class="mono">準備中…</div>
      <p class="note">
        ※ 承認QR例：<br/>
        APPROVE:v1:STORE=1:TYPE=STATIC
      </p>
    </div>
  </div>

  <script>
    const LIFF_ID = "2008691733-iSoNx2PY";

    const state = {
      displayName: "—",
      userId: null,
      points: 0,
      redeemableCount: 0,
      toNext: 0,
      rank: "レギュラー",
      // 申請情報（サーバから返ってきたものを保持）
      requestId: null,
      amount: 0,
      expectedPt: 0,
    };

    function setLog(text) {
      document.getElementById("log").textContent = text;
    }

    function show(screenId) {
      document.getElementById("home").classList.add("hidden");
      document.getElementById("amount").classList.add("hidden");
      document.getElementById(screenId).classList.remove("hidden");
    }

    function renderHome() {
      document.getElementById("hello").textContent =
        state.userId ? `こんにちは、${state.displayName} さん` : "ログイン中…";

      document.getElementById("points").textContent = String(state.points);
      document.getElementById("rankBadge").textContent = `ランク：${state.rank}`;
      document.getElementById("redeemable").textContent = `${state.redeemableCount}回`;
      document.getElementById("toNext").textContent = `${state.toNext}pt`;
    }

    async function apiGet(path) {
      const res = await fetch(path, { method: "GET" });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw { status: res.status, data };
      return data;
    }

    async function apiPost(path, body) {
      const res = await fetch(path, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw { status: res.status, data };
      return data;
    }

    async function refreshBalance() {
      if (!state.userId) return;
      const data = await apiGet(`/api/me?userId=${encodeURIComponent(state.userId)}`);
      state.points = data.points || 0;
      state.redeemableCount = data.redeemableCount || 0;
      state.toNext = data.toNext || 0;
      renderHome();
    }

    function setupUI() {
      document.getElementById("goAmount").addEventListener("click", () => {
        setLog("金額を入力して「申請する」を押してください");
        show("amount");
      });
      document.getElementById("backHome").addEventListener("click", () => show("home"));

      document.getElementById("refresh").addEventListener("click", async () => {
        try {
          setLog("残高更新中…");
          await refreshBalance();
          setLog("残高を更新しました");
        } catch (e) {
          setLog("残高更新エラー: " + JSON.stringify(e?.data || e));
        }
      });

      const yen = document.getElementById("yen");
      const calcPt = document.getElementById("calcPt");
      yen.addEventListener("input", () => {
        const v = Number(yen.value || 0);
        const pt = Math.floor(v / 500);
        calcPt.textContent = `${pt}pt`;
      });

      // 申請API
      document.getElementById("apply").addEventListener("click", async () => {
        try {
          if (!state.userId) {
            setLog("ユーザーID未取得です（LINE内で開いてください）");
            return;
          }
          const amount = Number(document.getElementById("yen").value || 0);
          const pt = Math.floor(amount / 500);
          if (amount <= 0) { setLog("金額を入力してください"); return; }

          setLog("申請中…");
          const r = await apiPost("/api/claim/request", {
            userId: state.userId,
            amount
          });

          state.requestId = r.requestId;
          state.amount = r.amount;
          state.expectedPt = r.pt;

          setLog(
            `申請OK\nrequestId=${state.requestId}\namount=${state.amount}\npt=${state.expectedPt}\n\n次に「承認QRを読み取る（付与）」を押してください`
          );
        } catch (e) {
          setLog("申請エラー: " + JSON.stringify(e?.data || e));
        }
      });

      // 承認QR読み取り → 付与API
      document.getElementById("scanApprove").addEventListener("click", async () => {
        try {
          if (!state.userId) { setLog("ユーザーID未取得です"); return; }
          if (!state.requestId) { setLog("先に「申請する」を押してください"); return; }

          if (!liff.isInClient()) {
            setLog("LINEアプリ内で開いていません。LINE内で miniapp URL を開いてください。");
            return;
          }

          // QR読み取り（scanCodeV2優先）
          let approveQr = null;
          if (typeof liff.scanCodeV2 === "function") {
            setLog("カメラ起動中…（QRを読み取ってください）");
            const res = await liff.scanCodeV2();
            approveQr = res?.value ?? "";
          } else if (typeof liff.scanCode === "function") {
            setLog("カメラ起動中…（QRを読み取ってください）");
            const res = await liff.scanCode();
            approveQr = res?.value ?? "";
          } else {
            setLog("この環境ではQR読取が利用できません（scanCodeV2/scanCodeが無効）");
            return;
          }

          setLog(`QR読取OK:\n${approveQr}\n\n付与処理中…`);

          // 付与API
          const a = await apiPost("/api/claim/approve", {
            userId: state.userId,
            requestId: state.requestId,
            amount: state.amount,
            approveQr
          });

          // 付与結果でUI更新
          state.points = a.balance;
          state.redeemableCount = a.redeemableCount;
          state.toNext = a.toNext;

          renderHome();
          setLog(
            `付与成功 ✅\nstoreId=${a.award.storeId}\npt=${a.award.pt}\n新残高=${a.balance}\n\nホームに戻って確認できます`
          );
        } catch (e) {
          // 同一店舗1日1回など
          if (e?.status === 409 && e?.data?.error === "ALREADY_AWARDED_TODAY") {
            setLog(`本日はこの店舗では付与済みです。\nstoreId=${e.data.storeId}\n日付=${e.data.date}`);
            return;
          }
          setLog("付与エラー: " + JSON.stringify(e?.data || e));
        }
      });
    }

    async function main() {
      setupUI();
      renderHome();

      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const p = await liff.getProfile();
        state.displayName = p.displayName || "—";
        state.userId = p.userId; // これが会員キー
        renderHome();

        // 初回残高取得
        setLog("残高取得中…");
        await refreshBalance();
        setLog("準備OK：金額入力へ進めます");
      } catch (e) {
        document.getElementById("hello").textContent = "LIFF初期化エラー：" + (e?.message || e);
        setLog("LIFF初期化エラー：" + (e?.message || e));
      }
    }

    main();
  </script>
</body>
</html>
