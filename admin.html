<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>管理画面：付与履歴</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 0; background: #f6f7f9; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border-radius: 14px; padding: 16px; box-shadow: 0 4px 16px rgba(0,0,0,.06); }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    label { font-size:12px; color:#475467; display:block; margin-bottom:6px; }
    input, select { padding:10px; border-radius:10px; border:1px solid #d0d5dd; font-size:14px; }
    button { padding:10px 14px; border:0; border-radius:10px; font-weight:800; cursor:pointer; }
    .btn { background:#111; color:#fff; }
    .muted { color:#667085; font-size:13px; }
    table { width:100%; border-collapse: collapse; margin-top:12px; }
    th, td { border-bottom:1px solid #eceff3; padding:10px; text-align:left; font-size:13px; }
    th { color:#475467; font-weight:800; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .kpi { display:flex; gap:14px; flex-wrap:wrap; margin-top:10px; }
    .kpi > div { background:#fbfcfd; border:1px solid #eceff3; border-radius:12px; padding:10px 12px; }
    .kpi b { font-size:18px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 style="margin:0 0 6px;">付与履歴（管理）</h1>
      <p class="muted" style="margin:0 0 12px;">
        ※ URLに token が必要です（例：/admin.html?token=XXXX）
      </p>

      <div class="row">
        <div>
          <label>token</label>
          <input id="token" class="mono" style="min-width:320px" placeholder="ADMIN_TOKEN を入力/URLに付ける" />
        </div>

        <div>
          <label>店舗</label>
          <select id="storeId">
            <option value="">全店舗</option>
            <option value="1">STORE 1</option>
            <option value="2">STORE 2</option>
            <option value="3">STORE 3</option>
            <option value="4">STORE 4</option>
            <option value="5">STORE 5</option>
          </select>
        </div>

        <div>
          <label>from</label>
          <input id="from" type="date" />
        </div>

        <div>
          <label>to</label>
          <input id="to" type="date" />
        </div>

        <div>
          <label>件数</label>
          <input id="limit" type="number" value="200" min="1" max="1000" style="width:110px" />
        </div>

        <button class="btn" id="load">読み込み</button>
      </div>

      <div id="kpi" class="kpi"></div>

      <table>
        <thead>
          <tr>
           <th>日時</th><th>店舗</th><th>金額</th><th>付与pt</th><th>氏名</th><th>user_id</th>

          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <p class="muted" style="margin-top:10px;">
        セキュリティ：token はURLに付けるだけの簡易方式です。本番で厳格にするなら、IP制限/ログイン/Basic認証などに変更できます。
      </p>
    </div>
  </div>

 <script>
  const qs = new URLSearchParams(location.search);
  const el = (id) => document.getElementById(id);

  function yen(n){ return (n||0).toLocaleString("ja-JP") + "円"; }
  function pt(n){ return (n||0).toLocaleString("ja-JP") + "pt"; }
  function dt(s){ try { return new Date(s).toLocaleString("ja-JP"); } catch { return s; } }

  // 画面に状況を出す（何が起きてるか分かるように）
  function setStatus(msg) {
    let box = document.getElementById("statusBox");
    if (!box) {
      box = document.createElement("div");
      box.id = "statusBox";
      box.style.marginTop = "10px";
      box.style.padding = "10px 12px";
      box.style.borderRadius = "12px";
      box.style.border = "1px solid #eceff3";
      box.style.background = "#fbfcfd";
      box.style.fontSize = "13px";
      box.style.whiteSpace = "pre-wrap";
      el("kpi").parentNode.insertBefore(box, el("kpi"));
    }
    box.textContent = msg;
  }

  async function load() {
    try {
      const token = (el("token").value || "").trim();
      if (!token) {
        setStatus("token が空です（URLに ?token=... を付けるか、入力欄に入れてください）");
        return;
      }

      const storeId = el("storeId").value;
      const from = el("from").value;
      const to = el("to").value;
      const limit = el("limit").value;

      const u = new URL("/api/admin/awards", location.origin);
      u.searchParams.set("token", token);
      if (storeId) u.searchParams.set("storeId", storeId);
      if (from) u.searchParams.set("from", from);
      if (to) u.searchParams.set("to", to);
      if (limit) u.searchParams.set("limit", limit);

      setStatus("読み込み中...\n" + u.toString());

      const res = await fetch(u.toString(), { cache: "no-store" });
      const text = await res.text();

      let data = null;
      try { data = JSON.parse(text); } catch { data = null; }

      if (!res.ok || !data || !data.ok) {
        setStatus("読み込み失敗\nHTTP " + res.status + "\n" + text);
        return;
      }

      // KPI
      const summary = data.summary || {
        totalAwards: data.rows?.length || 0,
        totalPoints: (data.rows||[]).reduce((s,r)=>s+(r.added_points||0),0),
        totalAmount: (data.rows||[]).reduce((s,r)=>s+(r.amount||0),0),
      };

      el("kpi").innerHTML = `
        <div><div class="muted">件数</div><b>${summary.totalAwards}</b></div>
        <div><div class="muted">合計付与pt</div><b>${pt(summary.totalPoints)}</b></div>
        <div><div class="muted">合計金額</div><b>${yen(summary.totalAmount)}</b></div>
      `;

      // Table
      const tbody = el("tbody");
      tbody.innerHTML = "";
      for (const r of data.rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${dt(r.awarded_at)}</td>
          <td>STORE ${r.store_id}</td>
          <td>${yen(r.amount)}</td>
          <td>${pt(r.added_points)}</td><td>${row.name || ""}</td>
          <td class="mono">${r.user_id}</td>
        `;
        tbody.appendChild(tr);
      }

      setStatus("読み込み成功（" + (data.rows?.length || 0) + "件）");
    } catch (e) {
      setStatus("JSエラーで停止しました:\n" + (e?.stack || String(e)));
    }
  }

  // ボタン動作
  el("load").addEventListener("click", load);

  // URL token があれば自動反映して自動読み込み
  window.addEventListener("load", () => {
    const t = qs.get("token");
    if (t) el("token").value = t;
    setTimeout(load, 50);
  });
</script>

</body>
</html>
